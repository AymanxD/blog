---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import { fetchBlogPostsByTag } from '../../services/blogApi';
import type { BlogPost } from '../../types/blog';

const { tag } = Astro.params;

if (!tag) {
  return Astro.redirect('/posts');
}

const url = new URL(Astro.request.url);
const page = parseInt(url.searchParams.get('page') || '1', 10);
const pageSize = 10;

let posts: BlogPost[] = [];
let total = 0;
let error: string | null = null;

try {
  const response = await fetchBlogPostsByTag(tag, page, pageSize);
  posts = response.posts;
  total = response.total;
} catch (e) {
  error = e instanceof Error ? e.message : 'Failed to load posts';
}

const totalPages = Math.ceil(total / pageSize);
const hasPrevPage = page > 1;
const hasNextPage = page < totalPages;
---

<BaseLayout title={`Posts tagged "${tag}" - Blog`}>
  <section class="tag-page">
    <header class="tag-header">
      <a href="/posts" class="back-link">← Back to all posts</a>
      <h1>Posts tagged <span class="tag-name">#{tag}</span></h1>
      <p class="post-count">{total} {total === 1 ? 'post' : 'posts'} found</p>
    </header>
    
    {error ? (
      <div class="error">
        <p>Unable to load posts: {error}</p>
        <p>Please make sure the backend API is running.</p>
      </div>
    ) : posts.length > 0 ? (
      <>
        <div class="posts-grid">
          {posts.map((post) => (
            <PostCard post={post} />
          ))}
        </div>
        
        {totalPages > 1 && (
          <nav class="pagination">
            {hasPrevPage ? (
              <a href={`/tags/${tag}?page=${page - 1}`} class="prev">← Previous</a>
            ) : (
              <span class="prev disabled">← Previous</span>
            )}
            
            <span class="page-info">Page {page} of {totalPages}</span>
            
            {hasNextPage ? (
              <a href={`/tags/${tag}?page=${page + 1}`} class="next">Next →</a>
            ) : (
              <span class="next disabled">Next →</span>
            )}
          </nav>
        )}
      </>
    ) : (
      <p class="no-posts">No posts found with this tag.</p>
    )}
  </section>
</BaseLayout>

<style>
  .tag-page {
    max-width: var(--max-width);
    margin: 0 auto;
  }

  .tag-header {
    margin-bottom: 3rem;
  }

  .back-link {
    display: inline-block;
    margin-bottom: 1.5rem;
    color: var(--color-text-light);
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  .tag-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
  }

  .tag-name {
    color: var(--color-primary);
  }

  .post-count {
    color: var(--color-text-light);
  }

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .error {
    background-color: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    padding: 1.5rem;
    color: #991b1b;
  }

  .no-posts {
    text-align: center;
    color: var(--color-text-light);
    padding: 3rem;
    background-color: var(--color-background-alt);
    border-radius: 8px;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 2rem;
    padding: 2rem 0;
    border-top: 1px solid var(--color-border);
  }

  .pagination a {
    padding: 0.5rem 1rem;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    transition: all 0.2s ease;
  }

  .pagination a:hover {
    background-color: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
    text-decoration: none;
  }

  .pagination .disabled {
    padding: 0.5rem 1rem;
    color: var(--color-text-light);
    opacity: 0.5;
  }

  .page-info {
    color: var(--color-text-light);
  }
</style>
